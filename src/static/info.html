<html lang="en">
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="info.css">
        <script>
            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get("name");

            async function handleErrors(response) {
                    const result = await response.json()
                    document.getElementById("status").innerHTML = "";
                    try {
                        Object.entries(result["errors"]).forEach(([key, value]) => {
                        const div = document.createElement("div");
                        div.innerText = key + ": " + value;
                        document.getElementById("status").appendChild(div);
                    });
                    } catch (error) {
                        document.getElementById("status").innerText = error.message;
                    }
                    
            }
        </script>
    </head>
    <body>
        <header>
            <a href="/"><h1>Info</h1></a>
        </header>
        <main>
            <div id="infodiv">
                <div id="status"></div>
                <table>
                    <tr>
                        <th colspan="2"><h2 id="collection_name"></h2></th>
                    </tr>
                    <tr>
                        <th>Name</th>
                        <th>Updated</th>
                    </tr>
                    <tr>
                        <td><input type="text" id="name"></td>
                        <td><input type="checkbox" id="updated"></td>
                    </tr>
                    <tr>
                        <th>Creation Date</th>
                        <th>Modification Date</th>
                    </tr>
                    <tr>
                        <td><input type="text" id="creation_date"></td>
                        <td><input type="text" id="modification_date"></td>
                    </tr>
                    <tr>
                        <th colspan="2">Description</th>
                    </tr>
                    <tr>
                        <td colspan="2"><textarea id="description"></textarea></td>
                    </tr>
                    <tr>
                        <td colspan="2"><input type="button" value="Save Changes" id="save" onclick="editCollection()"></td>
                    </tr>
                    <tr>
                        <td colspan="2"><input type="button" value="Delete Collection" id="delete" onclick="deleteCollection()"></td>
                    </tr>
                </table>
                <script>
                    async function deleteCollection() {
                        const response = await fetch("/api/Delete?name=" + name, {method: "DELETE"});
                        if (response.ok) {
                            window.location.href = "/";
                        } else {
                            await handleErrors();
                        }
                    }

                    async function editCollection() {
                        
                        const response = await fetch("/api/Edit", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                collection_name: name,
                                name: document.getElementById("name").value,
                                description: document.getElementById("description").value,
                                creation_date: document.getElementById("creation_date").value,
                                modification_date: document.getElementById("modification_date").value,
                                updated: document.getElementById("updated").checked
                            })
                        });
                        
                        if (response.ok) {
                            window.location.href = "/info.html?name=" + document.getElementById("name").value;
                        } else {
                            await handleErrors(response);
                        }
                    }

                    async function getInfo() {
                        document.getElementById("collection_name").innerText = name;
                        const response = await fetch("/api/Info?name=" + name);
                        if (response.ok) {
                            const result = await response.json()
                            document.getElementById("name").value = result["info"]["name"];
                            document.getElementById("updated").checked = result["info"]["updated"];
                            document.getElementById("creation_date").value = result["info"]["creation_date"];
                            document.getElementById("modification_date").value = result["info"]["modification_date"];
                            document.getElementById("description").value = result["info"]["description"];
                            
                        } else {
                            await handleErrors(response);
                        }
                    }
                    getInfo();
                </script>
            </div>
            <div id="backupdiv">
                <table id="backuptable">
                    <tr>
                        <th>Name</th>
                        <th>Date</th>
                        <th>Location</th>
                        <th>Delete</th>
                    </tr>
                </table>
                <script>
                    async function deleteBackup(name) {
                        const response = await fetch("/api/Unbackup", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                collection_name: document.getElementById("collection_name").innerText,
                                backup_name: name,
                            })
                        });
                        
                        if (response.ok) {
                            window.location.href = "/info.html?name=" + document.getElementById("collection_name").innerText;
                        } else {
                            await handleErrors(response);
                        }
                    }

                    async function getBackups() {
                        document.getElementById("collection_name").innerText = name;
                        const response = await fetch("/api/ListBackups?name=" + name);
                        if (response.ok) {
                            const result = await response.json();
                            let table = document.getElementById("backuptable");
                            Object.entries(result["backup_entries"]).forEach(([name, body]) => {
                                let tr = document.createElement("tr");
                                let td1 = document.createElement("td");
                                td1.innerText = name;
                                let td2 = document.createElement("td");
                                td2.innerText = body["date"];
                                let td3 = document.createElement("td");
                                td3.innerText = body["location"];
                                let td4 = document.createElement("td");
                                let button = document.createElement("input");
                                button.type = "button";
                                button.value = "Delete";
                                button.onclick = () => deleteBackup(name);
                                td4.appendChild(button);

                                tr.appendChild(td1);
                                tr.appendChild(td2);
                                tr.appendChild(td3);
                                tr.appendChild(td4);
                                table.appendChild(tr);
                            });
                            
                        } else {
                            await handleErrors(response);
                        }
                    }
                    getBackups();
                </script>
            </div>
            <div id="createbackupdiv">
                <table>
                    <tr>
                        <th>Backup Name</th>
                        <th>Backup Date</th>
                    </tr>
                    <tr>
                        <td><input type="text" id="backupname" value="Unique Name"></td>
                        <td><input type="text" id="backupdate" placeholder="Default is current timestamp"></td>
                    </tr>
                    <tr>
                        <th>Backup Location</th>
                        <th>Submit</th>
                    </tr>
                    <tr>
                        <td><input type="text" id="backuplocation" value="Backup Location"></td>
                        <td><input type="button" value="Create Backup Entry" id="createbackup" onclick="createBackupEntry()"></td>
                    </tr>
                </table>
                <script>
                    async function createBackupEntry() {
                        let backup_date = document.getElementById("backupdate").value
                        let jsonBody = {
                                collection_name: document.getElementById("collection_name").innerText,
                                backup_name: document.getElementById("backupname").value,
                                backup_location: document.getElementById("backuplocation").value,
                                backup_date: backup_date
                            }
                        if (backup_date == "") delete jsonBody["backup_date"];

                        const response = await fetch("/api/Backup", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(jsonBody)
                        });
                        
                        if (response.ok) {
                            window.location.href = "/info.html?name=" + document.getElementById("name").value;
                        } else {
                            await handleErrors(response);
                        }
                    }
                </script>
            </div>
        </main>
    </body>
</html>