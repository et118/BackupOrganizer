<html lang="en">
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="info.css">
    </head>
    <body>
        <header>
            <a href="/"><h1>Info</h1></a>
        </header>
        <main>
            <div id="infodiv">
                <div id="status"></div>
                <table>
                    <tr>
                        <th colspan="2"><h2 id="collection_name"></h2></th>
                    </tr>
                    <tr>
                        <th>Name</th>
                        <th>Updated</th>
                    </tr>
                    <tr>
                        <td><input type="text" id="name"></td>
                        <td><input type="checkbox" id="updated"></td>
                    </tr>
                    <tr>
                        <th>Creation Date</th>
                        <th>Modification Date</th>
                    </tr>
                    <tr>
                        <td><input type="text" id="creation_date"></td>
                        <td><input type="text" id="modification_date"></td>
                    </tr>
                    <tr>
                        <th colspan="2">Description</th>
                    </tr>
                    <tr>
                        <td colspan="2"><textarea id="description"></textarea></td>
                    </tr>
                    <tr>
                        <td colspan="2"><input type="button" value="Save Changes" id="save" onclick="editCollection()"></td>
                    </tr>
                    <tr>
                        <td colspan="2"><input type="button" value="Delete Collection" id="delete" onclick="deleteCollection()"></td>
                    </tr>
                </table>
                <script>
                    const urlParams = new URLSearchParams(window.location.search);
                    const name = urlParams.get("name");

                    async function handleErrors(response) {
                            const result = await response.json()
                            document.getElementById("status").innerHTML = "";
                            Object.entries(result["errors"]).forEach(([key, value]) => {
                                const div = document.createElement("div");
                                div.innerText = key + ": " + value;
                                document.getElementById("status").appendChild(div);
                            });
                    }

                    async function deleteCollection() {
                        const response = await fetch("/api/Delete?name=" + name, {method: "DELETE"});
                        if (response.ok) {
                            window.location.href = "/";
                        } else {
                            await handleErrors();
                        }
                    }

                    async function editCollection() {
                        
                        const response = await fetch("/api/Edit", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                collection_name: name,
                                name: document.getElementById("name").value,
                                description: document.getElementById("description").value,
                                creation_date: document.getElementById("creation_date").value,
                                modification_date: document.getElementById("modification_date").value,
                                updated: document.getElementById("updated").checked
                            })
                        });
                        
                        if (response.ok) {
                            window.location.href = "/info.html?name=" + document.getElementById("name").value;
                        } else {
                            await handleErrors();
                        }
                    }

                    async function getInfo() {
                        document.getElementById("collection_name").innerText = name;
                        const response = await fetch("/api/Info?name=" + name);
                        if (response.ok) {
                            const result = await response.json()
                            document.getElementById("name").value = result["info"]["name"];
                            document.getElementById("updated").checked = result["info"]["updated"];
                            document.getElementById("creation_date").value = result["info"]["creation_date"];
                            document.getElementById("modification_date").value = result["info"]["modification_date"];
                            document.getElementById("description").value = result["info"]["description"];
                            
                        } else {
                            await handleErrors();
                        }
                    }
                    getInfo();
                </script>
            </div>
            <div id="backupdiv">
                
            </div>
        </main>
    </body>
</html>